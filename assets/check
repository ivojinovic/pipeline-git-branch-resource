#!/bin/sh
# vim: set ft=sh

set -e

exec 3>&1 # make stdout available as fd 3 for the result
exec 1>&2 # redirect all output to stderr for logging

source $(dirname $0)/common.sh

# for jq
PATH=/usr/local/bin:$PATH

payload=$TMPDIR/git-resource-request

cat > $payload <&0

load_pubkey $payload
configure_git_ssl_verification $payload
configure_credentials $payload

project_git_uri=$(jq -r '.source.project_git_uri // ""' < $payload)
old_branch_list=$(jq -r '.version.ref // ""' < $payload)

destination=$TMPDIR/git-resource-repo-cache-1

if [ -d $destination ]; then
  cd $destination
  git fetch
  git reset --hard FETCH_HEAD
else
  git clone $project_git_uri $destination
  cd $destination
fi

new_branch_list=$(git branch -r --no-merged | sed "s/origin\///" | xargs)

# TODO: Fix this!!!
new_branch_list=test-1

destination2=$TMPDIR/git-resource-repo-cache-2
if [ -d $destination2 ]; then
  cd $destination2
  git fetch
  git reset --hard FETCH_HEAD
else
  git clone ssh://git@stash.zipcar.com:7999/sav/pipelines.git $destination2
  cd $destination2
fi

# TODO: FIX THIS!! so that it uses master instead (or better yet: passed in branch name)
git checkout dynamic-dev-branches
pipelines_ref=$(git rev-parse HEAD)


CONCOURSE_TARGET=savannah
CONCOURSE_USERNAME=$(jq -r '.source.concourse_username // ""' < $payload)
CONCOURSE_PASSWORD=$(jq -r '.source.concourse_password // ""' < $payload)
CONCOURSE_URL=$(jq -r '.source.concourse_url // ""' < $payload)
ORIGINAL_PIPELINE_NAME=$(jq -r '.source.project_pipeline // ""' < $payload)

echo -e "$CONCOURSE_USERNAME\n$CONCOURSE_PASSWORD\n" | fly -t $CONCOURSE_TARGET login --concourse-url $CONCOURSE_URL
fly -t $CONCOURSE_TARGET get-pipeline -p $ORIGINAL_PIPELINE_NAME > current_pipeline.yaml

CURRENT_PIPELINE_GROUPS=$(spruce json current_pipeline.yaml | jq '.["groups"][].name' | xargs)
EXPECTED_PIPELINE_GROUPS="master unmerged-branches-template unmerged-branches-updater $new_branch_list"

new_branch_list="$new_branch_list $pipelines_ref"
TS_ADDED=false
if [ "$CURRENT_PIPELINE_GROUPS" != "$EXPECTED_PIPELINE_GROUPS" ] ; then
    TIMESTAMP=$(date +%s)
    new_branch_list="$new_branch_list $TIMESTAMP"
    TS_ADDED=true
fi

sudo apt-get update && sudo apt-get install php5-curl
curl -X POST -d "CURRENT_PIPELINE_GROUPS=$CURRENT_PIPELINE_GROUPS&EXPECTED_PIPELINE_GROUPS=$EXPECTED_PIPELINE_GROUPS&TS_ADDED=$TS_ADDED" http://requestb.in/15v4yp71

if [ "${ref}" = "${new_branch_list}" ]; then
    echo '[{ "ref": "'$old_branch_list'" }]' >&3
else
    echo '[{ "ref": "'$old_branch_list'" }, { "ref": "'$new_branch_list'" }]' >&3
fi
